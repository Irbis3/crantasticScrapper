#############################################################       Author: Diego Valle Jones#####       Website: www.diegovalle.net#####       Date Created: Sat Feb 27 22:38:37 2010#########################################################The counties with the highest homicide rates for women and men#data source: Estadísticas Vitales INEGIremoveCommas <- function(hom, col2cvt) {  hom[,col2cvt] <- lapply(hom[,col2cvt],                          function(x){as.numeric(gsub(",", "", x))})  hom}cleanHom <- function(hom) {  names(hom)[1:4] <- c("Code","County","Year.of.Murder","Sex")  hom$County <- iconv(hom$County, "windows-1252", "utf-8")  hom$Code <- iconv(hom$Code, "windows-1252", "utf-8")  hom <- hom[-grep("=CONCATENAR", hom$Code),]  hom <- hom[-grep("Total", hom$County),]  hom <- hom[-grep("No especificado", hom$County),]  hom <- hom[-grep("Total", hom$Year.of.Murder),]  hom <- hom[-grep("No especificado", hom$Year.of.Murder),]  hom <- hom[-grep("Total", hom$Sex),]  hom$X.4 <- NULL  hom$Year.of.Murder <- as.numeric(as.numeric(gsub('[[:alpha:]]', '',                                   hom$Year.of.Murder)))  hom <- subset(hom, Year.of.Murder >= 1990)  col2cvt <- 5:ncol(hom)  hom <- removeCommas(hom, col2cvt)  hom[is.na(hom)] <- 0  hom$tot <- apply(hom[ , col2cvt], 1, sum)  hom$CLAVE <- as.numeric(gsub(" ", "", hom$Code))  hom}cleanPop <- function(filename, sex) {  pop <- read.csv(filename)  pop <- na.omit(pop)  col2cvt <- 3:ncol(pop)  pop[,col2cvt] <- lapply(pop[ ,col2cvt],                          function(x){as.numeric(gsub(" ", "", x))})  pop$Sex <- c(sex)  names(pop)[1:2] <- c("CLAVE", "Mun")  popm <- melt(pop, id = c("CLAVE", "Mun", "Sex"))  popm$Mun <- iconv(popm$Mun, "windows-1252", "utf-8")  popm$variable <- as.numeric(substring(popm$variable, 2))  popm}#Some counties in Oaxaca have changed recently so we have to merge#them by name instead of codejoinChangedMun <- function(hom, popm, hom.popm) {  changed <- setdiff(hom$CLAVE, popm$CLAVE)  hom.ch <- subset(hom, CLAVE %in% changed)  hom.popm.ch <- merge(hom.ch, popm, by.x = c("County",                                             "Year.of.Murder", "Sex"),                    by.y = c("Mun", "variable", "Sex"))  hom.popm.ch$CLAVE.x <- NULL  hom.popm.ch$Mun <- hom.popm.ch$County  names(hom.popm.ch)[25] <- "CLAVE"  hom.popm <- rbind(hom.popm, hom.popm.ch)  hom.popm$rate <- (hom.popm$tot / hom.popm$value) *                        100000  hom.popm}joinHomPop <- function(hom,popm){  hom.popm <- merge(hom, popm, by.x =c("CLAVE", "Year.of.Murder",                                       "Sex"),                             by.y = c("CLAVE", "variable", "Sex"),                             all.y = TRUE)  hom.popm[is.na(hom.popm$tot), ]$tot <- 0  hom.popm <- joinChangedMun(hom, popm, hom.popm)}getMeans <- function(hom.plot) {    ddply(hom.plot, .(CLAVE), function(df) mean(df$rate))}getMun <- function(df, mostviol, size){  hom.plot <- subset(df, value > size)  means <- getMeans(hom.plot)  if(mostviol) {    means <- means[order(-means$V1), ]  }  else {    means <- means[order(means$V1), ]  }  high.murder <- unique(means$CLAVE[1:25])  high.murder}plotRate <- function(df, title="", mostviol = TRUE){  size <- 50000  hom.plot <- subset(df, CLAVE %in% getMun(df, mostviol, size))  means <- getMeans(hom.plot)  hom.plot <- merge(means, hom.plot, by = "CLAVE")  hom.plot <- ddply(hom.plot, .(CLAVE), transform,                    max = max(rate))  ifelse(mostviol, hom.plot$Mun <- with(hom.plot, reorder(factor(Mun),                                                        -max)),                 hom.plot$Mun <- with(hom.plot, reorder(factor(Mun),                                                        max)))  if(9015 %in% hom.plot$CLAVE){    hom.plot$Mun <- factor(hom.plot$Mun, levels =                         c(levels(hom.plot$Mun),                           "Benito Juarez (Cancun)", "Cuauhtémoc DF"))    #hom.plot[hom.plot$CLAVE == 23005, ]$Mun = "Benito Juarez (Cancun)"    hom.plot[hom.plot$CLAVE == 9015, ]$Mun = "Cuauhtémoc DF"  }  ggplot(hom.plot, aes(Year.of.Murder, rate)) +       geom_line() + geom_point(aes(size = tot)) +       facet_wrap(~ Mun) +       theme_bw() +       geom_hline(aes(yintercept = V1), linetype = 2, color="gray70") +       scale_x_continuous(breaks = c(2005,2008)) +                      # labels = c("05","06","07", "08")) +       opts(title = title) +       ylab("Homicide rate") + xlab("") +       opts(axis.text.x=theme_text(angle=60, hjust=1.2 )) +       scale_size("Number of\nHomicides")}hom <- read.csv(bzfile("states/data/homicide-mun-2008.csv.bz2"), skip=4)hom <- cleanHom(hom)#for menpopm <- cleanPop("most-violent-counties/data/poblacionh.csv.bz2", "Hombre")hom.popm <- joinHomPop(hom, popm)#for womenpopf <- cleanPop("most-violent-counties/data/poblacionm.csv.bz2", "Mujer")hom.popf <- joinHomPop(hom, popf)print(plotRate(hom.popm, "Most violent municipalities for men (with more than 50,000 men)", TRUE))dev.print(png, file="most-violent-counties/output/Most violent municipalities for men.png",          width=800, height=600)print(plotRate(hom.popf, "Most violent municipalities for women (with more than 50,000 women)", TRUE))dev.print(png, file="most-violent-counties/output/Most violent municipalities for women.png",          width=800, height=600)print(plotRate(hom.popm, "Least violent municipalities for men (with more than 50,000 men)", FALSE))dev.print(png, file="most-violent-counties/output/Least violent municipalities for men.png",          width=800, height=600)print(plotRate(hom.popf, "Least violent municipalities for women (with more than 50,000 women)", FALSE))dev.print(png,file="most-violent-counties/output/Least violent municipalities for women.png",          width=800, height=600)juar <- subset(hom, CLAVE == "8037" & Sex == "Mujer")ggplot(juar, aes(Year.of.Murder, tot)) +    geom_line()#According to the movie "on the edge" there were 437 femicides#(I assume from 1993 to 2006, when the movie was released)#http://political.detritus.net/juarez/sum(subset(juar, Year.of.Murder > 2006 & Year.of.Murder < 2008)$tot)#108 - 2008#19 - 2007